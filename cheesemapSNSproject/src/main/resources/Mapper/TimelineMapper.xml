<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<!-- 마이메뉴 처리 SQL -->
<mapper namespace="com.scmaster.cheesemap.dao.TimelineMapper">
	<select id="getTimeline" resultType="Board" parameterType="String">
		select
			boa_id
			, boa_content
			, boa_create_date
			, boa_modify_date
			, boa_latitude
			, boa_longitude
			, boa_photo_savefile
			, boa_photo_originalfile
			, boa_video_originalfile
			, boa_video_savefile
			, mem_id
		from
			CS_BOARD
		where
			boa_id = #{boa_id}
		and
			boa_delete_date is null
	</select>
	
	<select id="getBoardComment" resultType="BoardComment" parameterType="String">
		select
			com_id
			, com_content
			, com_create_date
			, com_modify_date
			, mem_id
			, boa_id
		from
			CS_BOARD_COMMENT
		where
			boa_id = #{boa_id}
	</select>
	
	<select id="getBoardTag"  resultType="BoardTag" parameterType="String">
		select
			tag_name
			, boa_id
		from
			CS_BOARD_TAG
		where
			boa_id = #{boa_id}
		order by
			tag_name
	</select>
	
	<select id="getBoardLike" resultType="BoardLike" parameterType="String">
		select
			mem_id
			, boa_id
		from
			CS_BOARD_LIKE
		where
			boa_id = #{boa_id}
	</select>
	
	<select id="followCheck" resultType="String" parameterType="String">
		select
			FOL_FOLLOWING
		from
			CS_FOLLOW
		where
			FOL_FOLLOWER = #{fol_follower}
		and
			FOL_FOLLOWING = #{fol_following}
	</select>
	
	<insert id="followAdd" parameterType="Follow">
		insert into
			CS_Follow (
				fol_follower
				, fol_following
			) values (
				#{fol_follower}
				, #{fol_following}
			)
	</insert>
	
	<delete id="followRemove" parameterType="Follow">
		delete from
			CS_Follow
		where
			fol_follower = #{fol_follower}
		and
			fol_following = #{fol_following}
	</delete>
	
	<update id="deleteBoard" parameterType="String">
		update
			CS_BOARD
		set
			boa_delete_date = sysdate
		where
			boa_id = #{boa_id}
	</update>
	
	<delete id="deleteBoardTag" parameterType="String">
		delete from
			CS_BOARD_TAG
		where	
			boa_id = #{boa_id}
	</delete>

	<select id="getBoardByDivision" parameterType="String" resultType="Board">
	SELECT 	
		boa_id
		, <![CDATA[CASE 
		WHEN INSTR(BOA_CONTENT,'<img')= 0 AND INSTR(BOA_CONTENT,'<video')= 0
		THEN BOA_CONTENT
		WHEN INSTR(BOA_CONTENT,'<video')= 0
		THEN SUBSTR(BOA_CONTENT,1,INSTR(BOA_CONTENT,'<img')-1)||
       		 SUBSTR(BOA_CONTENT,INSTR(BOA_CONTENT,'<img')+INSTR(SUBSTR(BOA_CONTENT,INSTR(BOA_CONTENT,'<img')),'>'))
      	WHEN INSTR(BOA_CONTENT,'<img')= 0
		THEN SUBSTR(BOA_CONTENT,1,INSTR(BOA_CONTENT,'<video')-1)||
       		 SUBSTR(BOA_CONTENT,INSTR(BOA_CONTENT,'<video')+INSTR(SUBSTR(BOA_CONTENT,INSTR(BOA_CONTENT,'<video')),'/video>')+6)
      	WHEN (INSTR(BOA_CONTENT,'<img') < INSTR(BOA_CONTENT,'<video')) AND INSTR(BOA_CONTENT,'<video') != 0
		THEN SUBSTR(BOA_CONTENT,1,INSTR(BOA_CONTENT,'<img')-1)||
       		 SUBSTR(BOA_CONTENT,INSTR(BOA_CONTENT,'<img')+INSTR(SUBSTR(BOA_CONTENT,INSTR(BOA_CONTENT,'<img')),'>'),INSTR(BOA_CONTENT,'<video')-(INSTR(BOA_CONTENT,'<img')+INSTR(SUBSTR(BOA_CONTENT,INSTR(BOA_CONTENT,'<img')),'>')))||
       		 SUBSTR(BOA_CONTENT,INSTR(BOA_CONTENT,'<video')+INSTR(SUBSTR(BOA_CONTENT,INSTR(BOA_CONTENT,'<video')),'/video>')+6) 
       	WHEN (INSTR(BOA_CONTENT,'<img') > INSTR(BOA_CONTENT,'<video')) AND INSTR(BOA_CONTENT,'<video') != 0
		THEN SUBSTR(BOA_CONTENT,1,INSTR(BOA_CONTENT,'<video')-1)||
       		 SUBSTR(BOA_CONTENT,INSTR(BOA_CONTENT,'<video')+INSTR(SUBSTR(BOA_CONTENT,INSTR(BOA_CONTENT,'<video')),'/video>')+6,INSTR(BOA_CONTENT,'<img')-(INSTR(BOA_CONTENT,'<video')+INSTR(SUBSTR(BOA_CONTENT,INSTR(BOA_CONTENT,'<video')),'/video>')+6))||
       		 SUBSTR(BOA_CONTENT,INSTR(BOA_CONTENT,'<img')+INSTR(SUBSTR(BOA_CONTENT,INSTR(BOA_CONTENT,'<img')),'>'))
       	END	AS BOA_CONTENT]]>
		, to_char(boa_create_date, 'YYYY.MM.DD, DAY PM HH12:MI') boa_create_date
		, boa_latitude
		, boa_longitude
		, boa_photo_savefile
		, boa_video_savefile
		, mem_id
	from CS_BOARD
	where boa_id=#{boa_id}
	</select>
</mapper>
